# vscode-keybindings-builder

## Overview

A TypeScript library that provides a programmatic builder API for generating and managing VSCode keybindings configurations. It simplifies the process of maintaining custom keybindings while providing control over default keybindings behavior.

## Core Features

- **Builder Pattern API**: Fluent interface for defining keybindings
- **Default Keybinding Management**: Control how default keybindings are handled (clear, preserve, or preset)
- **Type Safety**: Full TypeScript support with proper typing for commands and conditions
- **Validation**: Detect duplicate keybindings and configuration errors at build time
- **JSONC Support**: Parse and understand VSCode's default keybindings format (JSON with Comments)

## Requirements

### Input Files

- **Default Keybindings**: User must provide VSCode's default keybindings file (`default-keybindings.jsonc`)
  - Can be obtained from VSCode: Preferences > Keyboard Shortcuts > Open Default Keyboard Shortcuts (JSON)
- **Current Keybindings** (optional): Path to existing user keybindings for merging/updating

### Output

- Generated keybindings file in VSCode-compatible JSON format
- Does NOT automatically overwrite user's keybindings.json (manual update required for safety)
- Preserves manually added keybindings from existing configuration

## API Design

### Builder Configuration

```ts
interface BuilderConfig {
  dirname: string; // Directory for input/output files
  currentKeybindingPath?: string; // Path to existing keybindings (optional)
  defaultKeybindingsFile?: string; // Name of default keybindings file (default: "default-keybindings.jsonc")
  outputFile?: string; // Output filename (default: "keybindings-generated.json")
}

interface BuildResult {
  keybindingsCount: number; // Number of keybindings generated by builder
  preservedCount: number; // Number of manual keybindings preserved
  outputPath: string; // Path to generated file
  warnings: string[]; // List of warnings (e.g., preserved manual keybindings)
}
```

### Key Handling Modes

- **`clearDefault`**: Disable all default keybindings for this key combination
- **`preserveDefault`**: Keep existing default keybindings alongside custom ones

### Usage Example

```ts
import { createBuilder } from "vscode-keybindings-builder";

// Initialize builder with configuration
const builder = createBuilder({
  dirname: import.meta.dirname,
  currentKeybindingPath: "./keybindings.json", // optional
});

// Define zoom controls (grouped for organization)
const registerZoomControls = () => {
  // Clear all default bindings for cmd+numpad_add
  builder
    .key("cmd+numpad_add", "clearDefault")
    .command("workbench.action.zoomIn")
    .register();

  // Keep default bindings and add new one
  builder
    .key("cmd+numpad_subtract", "preserveDefault")
    .command("workbench.action.zoomOut", {
      when: "editorTextFocus",
    })
    .register();

  // Override default with custom command
  builder
    .key("cmd+numpad0", "overrideDefault")
    .command("workbench.action.zoomReset", {
      when: "editorTextFocus",
    })
    .register();
};

// Define editor navigation
const registerEditorNav = () => {
  builder
    .key("ctrl+tab", "clearDefault")
    .command("workbench.action.nextEditor")
    .register();

  builder
    .key("ctrl+shift+tab", "clearDefault")
    .command("workbench.action.previousEditor")
    .register();
};

// Register all keybindings
registerZoomControls();
registerEditorNav();

// Build and write output file
try {
  const result = await builder.build();
  console.log(`Generated ${result.keybindingsCount} keybindings`);
  console.log(`Output written to: ${result.outputPath}`);

  // Display warnings for preserved manual keybindings
  if (result.warnings.length > 0) {
    console.warn("Warnings:");
    result.warnings.forEach((warning) => console.warn(`  - ${warning}`));
  }

  // Show preserved manual keybindings count
  if (result.preservedCount > 0) {
    console.log(`Preserved ${result.preservedCount} manual keybindings`);
  }
} catch (error) {
  console.error("Build failed:", error.message);
  // Errors include:
  // - Duplicate key definitions within builder
  // - Conflicts between builder and manual keybindings
  // - Missing required files
}
```

## Implementation Notes

### Current Keybindings Integration

When `currentKeybindingPath` is provided:

1. **Conflict Detection**: Build fails if manual keybindings conflict with builder-defined keybindings

   - A conflict occurs when the same key combination exists in both manual and builder definitions
   - Error message should clearly indicate which keys are conflicting

2. **Preservation of Manual Entries**: Non-conflicting manual keybindings are preserved

   - Keybindings not defined in the builder are carried over to the output
   - Warning is displayed for each preserved manual keybinding

3. **Build Output**: Final output includes:
   - All builder-defined keybindings
   - All non-conflicting manual keybindings from current configuration
   - Proper handling of default keybinding overrides

Example conflict scenario:

```ts
// Current keybindings.json has:
{ "key": "cmd+k", "command": "workbench.action.clearConsole" }

// Builder defines:
builder.key("cmd+k", "clearDefault").command("editor.action.format")

// Result: BUILD FAILS with error:
// "Conflict: 'cmd+k' is defined in both manual keybindings and builder"
```

Example preservation scenario:

```ts
// Current keybindings.json has:
{ "key": "cmd+shift+p", "command": "workbench.action.showCommands" }

// Builder doesn't define cmd+shift+p

// Result: Warning displayed, keybinding preserved in output:
// "Warning: Preserving manual keybinding 'cmd+shift+p' not defined in builder"
```

### Error Handling

- **Duplicate Keys**: Throw error if same key combination is registered multiple times in builder
- **Conflicts**: Throw error if builder keys conflict with manual keybindings
- **Invalid Commands**: Warn about unrecognized VSCode commands (optional validation)
- **Missing Files**: Clear error messages for missing default keybindings file

### JSONC Parsing

- Must handle comments in default keybindings file
- Preserve formatting for readability in output

### Output Format

Generated file should match VSCode's expected format:

```json
[
  {
    "key": "cmd+numpad_add",
    "command": "-defaultCommand" // Disable default
  },
  {
    "key": "cmd+numpad_add",
    "command": "workbench.action.zoomIn"
  }
]
```

## Future Enhancements

- **Import/Export**: Support for importing existing keybindings configurations
- **Presets**: Built-in preset configurations (vim mode, emacs mode, etc.)
- **Validation**: Check commands against known VSCode command list
- **Interactive Mode**: CLI tool for interactive keybinding configuration
- **Multi-platform**: Handle platform-specific keybindings (Windows/Mac/Linux)
